#!/bin/bash

# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./automation/annotate_dataset.sh <–ø—É—Ç—å_–∫_–¥–∞—Ç–∞—Å–µ—Ç—É>

set -e

echo "‚úèÔ∏è –ó–∞–ø—É—Å–∫ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞"
echo "============================="

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –¥–∞—Ç–∞—Å–µ—Ç—É"
    echo "üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./automation/annotate_dataset.sh <–ø—É—Ç—å_–∫_–¥–∞—Ç–∞—Å–µ—Ç—É>"
    exit 1
fi

DATASET_PATH="$1"
if [ ! -f "$DATASET_PATH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª $DATASET_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ ! -d "venv" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ venv –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    exit 1
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üîß –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source venv/bin/activate

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
ANNOTATION_SCRIPT="temp_annotate_$(date +%s).py"

echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏..."
cat > "$ANNOTATION_SCRIPT" << 'EOF'
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω automation/annotate_dataset.sh
"""

import json
import sys
from pathlib import Path

def find_entity_position(text, entity_text, start_hint=0):
    """–ù–∞—Ö–æ–¥–∏—Ç –ø–æ–∑–∏—Ü–∏—é —Å—É—â–Ω–æ—Å—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ"""
    pos = text.find(entity_text, start_hint)
    if pos == -1:
        # –ü—Ä–æ–±—É–µ–º —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–±–µ–ª–æ–≤
        normalized_entity = ' '.join(entity_text.split())
        normalized_text = ' '.join(text.split())
        pos = normalized_text.find(normalized_entity, start_hint)
        if pos != -1:
            # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
            pos = text.find(entity_text.strip(), start_hint)
    return pos

def annotate_dataset(dataset_path):
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏"""
    print(f"üîç –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞: {dataset_path}")
    
    # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
    # –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –¥–æ–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
    
    print("‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é")
    print("üí° –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –ª–æ–≥–∏–∫—É —Ä—É—á–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python script.py <–ø—É—Ç—å_–∫_–¥–∞—Ç–∞—Å–µ—Ç—É>")
        sys.exit(1)
    
    annotate_dataset(sys.argv[1])
EOF

echo "üéØ –ó–∞–ø—É—Å–∫ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è: $DATASET_PATH"
python "$ANNOTATION_SCRIPT" "$DATASET_PATH"

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "$ANNOTATION_SCRIPT"

echo "‚úÖ –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞" 